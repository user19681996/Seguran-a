apiVersion: v1
kind: Namespace
metadata:
  name: orion
---
apiVersion: v1
kind: Secret
metadata:
  name: orion-secrets
  namespace: orion
type: Opaque
stringData:
  DATABASE_URL: postgresql+psycopg://orion:orion@orion-postgres:5432/orion
  JWT_SECRET: CHANGE_ME_K8S_SECRET
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: orion-postgres
  namespace: orion
spec:
  replicas: 1
  selector:
    matchLabels: { app: orion-postgres }
  template:
    metadata:
      labels: { app: orion-postgres }
    spec:
      containers:
        - name: postgres
          image: postgres:16
          env:
            - {name: POSTGRES_DB, value: "orion"}
            - {name: POSTGRES_USER, value: "orion"}
            - {name: POSTGRES_PASSWORD, value: "orion"}
          ports: [{containerPort: 5432}]
---
apiVersion: v1
kind: Service
metadata:
  name: orion-postgres
  namespace: orion
spec:
  selector: { app: orion-postgres }
  ports: [{port: 5432, targetPort: 5432}]
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: orion-api
  namespace: orion
spec:
  replicas: 2
  selector:
    matchLabels: { app: orion-api }
  template:
    metadata:
      labels: { app: orion-api }
    spec:
      containers:
        - name: api
          image: orion/api:0.7.0
          env:
            - name: DATABASE_URL
              valueFrom: {secretKeyRef: {name: orion-secrets, key: DATABASE_URL}}
            - name: JWT_SECRET
              valueFrom: {secretKeyRef: {name: orion-secrets, key: JWT_SECRET}}
            - {name: ACCESS_TTL_MIN, value: "120"}
            - {name: RATE_LIMIT_PER_MINUTE, value: "120"}
            - {name: RATE_LIMIT_BURST, value: "60"}
          ports: [{containerPort: 8000}]
---
apiVersion: v1
kind: Service
metadata:
  name: orion-api
  namespace: orion
spec:
  selector: { app: orion-api }
  ports: [{port: 80, targetPort: 8000}]
